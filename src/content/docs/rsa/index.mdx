---
title: RSA暗号
description: 代表的な暗号を理解しよう
prev: false
next: false
---

# 代表的な公開鍵暗号を理解しよう

**RSA暗号**は、1977年にRon Rivest, Adi Shamir, Leonard Adleman によって発明されました。
公開鍵暗号として有名なRSA暗号がどのような手順で行われているのか、なぜ安全とされているのかを見ていきましょう。

## 手順

---

では早速、RSA暗号を用いて暗号化、復号、署名を行うための数学的な手順を解説します。なぜ成り立つか気になる方は[補足](#数学についての補足)を参照してください。

### 鍵生成

まず、相異なる十分大きな素数 $p, q$ を取得し、$n = pq$ とします。

そして、$ϕ(n)=(p−1)(q−1)$ と互いに素な自然数 $e$ をとります。ここで、$ϕ(n)$ はオイラーのトーシェント関数です。

すると、$$de \equiv ed \equiv 1 \pmod{(p-1)(q-1)}$$ を満たす自然数 $d$ が存在し、この $d$ は $p$ と $q$ を知っている状況下で容易に計算できます。

$n, e$ を公開鍵とし、$d$ を秘密鍵とします。

実際は慣例的に $e = 65537$ とされます。（ちなみにこれは 16 進数で 10001 です）

出てきたパラメータを表にまとめると以下の通りです。

|               |                                       |
| ------------- | ------------------------------------- | --- |
| 公開鍵        | 秘密鍵                                |
| $n (= pq)$    | $p, q$ （相異なる十分大きな素数）     |     |
| $e (= 65537)$ | $d (\equiv e^{-1} \pmod{(p-1)(q-1)})$ |

### 暗号化

平文を $m$ とします。

このとき、暗号文 $c$ は、公開鍵 $n, e$ を用いて $ c \equiv m^e \pmod n$ と計算されます。

### 復号

[オイラーの定理](#オイラーの定理)より $ m \equiv c^d \pmod n$ が成り立ちます。

よって、秘密鍵 $d$ を知っていると暗号文 $c$ から平文 $m$ が復元できます。

暗号化は公開鍵を使うだけで誰でもできるのに対し、復号は秘密鍵を持っている人だけができる点に着目してください。

### 署名

送信者は送りたいメッセージ $m$ のハッシュ値 $H(m)$ を計算し、送信者の秘密鍵 $d$ を用いて署名 $s \equiv H(m)^d \pmod n$ を作成し、暗号文とともに送信します。

受信者は受け取った署名 $s$ から送信者の公開鍵 $e$ を用いてハッシュ値を復元します。$ H(m) \equiv s^e \pmod n$

復元したハッシュ値 $H(m)$ と、受け取った暗号文を復号したメッセージ $m'$ から計算したハッシュ値 $H(m')$ が等しいことを確認します。
もし等しくない場合、メッセージで途中で改ざんされたなどの可能性が考えられます。

### 暗号の手順を体験してみよう

フォームにメッセージを書いて送信してみてください。
以下の情報がそれぞれ表示されます。

- メッセージを UTF-8 で数値にしたもの
- 暗号文
- 暗号文を UTF-8 で（無理やり）文章に変換したもの
- 復号した暗号文
- 復号したメッセージを UTF-8 で文章に戻したもの

TODO：RSA暗号体験フォーム

## 仕組み

---

RSA暗号の手順だけ先に解説しましたが、ここではなぜその手順でうまくいくのかを説明します。

### 素因数分解

もしも公開鍵 $n, e$ から 秘密鍵 $d$ を計算できてしまうと、他人が暗号を勝手に解読できてしまうことになります。

そして秘密鍵 $d$ は 内部パラメータの素数 $p, q$ を知ることができれば簡単に計算できます。

$n = pq$ から $p, q$ を知る、つまり $n$ を素因数分解できてしまうと大変なことになりますが、$p, q$ の桁数が十分大きく、適切な条件を満たしているとき、$n = pq$ を素因数分解するためには途方のない時間がかかるとされています。

このように素因数分解が難しいことが、RSA暗号の安全性を保証しています。

:::tip[素因数分解のアルゴリズムについて]

素因数分解をするための素朴なアルゴリズムとして、$2$ 以上 $\sqrt{n}$ 以下のすべての素数に対し、$n$ を何回割り切れるかを順々に調べていくという方法が考えられます。

素因数分解の古典的アルゴリズムのうち、最も効率が良いとされるのが**一般数体ふるい法**です。

TODO：RSA-2048や解読できるビット数の話

量子コンピューターを用いて実行可能な**ショアのアルゴリズム**は、素因数分解を十分高速に行うことができます。
そのため、後々量子技術が発展するとRSA暗号は機能しなくなると考えられています。
もっとも、量子技術にある程度は耐性のあるとされている暗号がすでに使われており、暗号技術そのものが危機にさらされるというわけではないことに注意してください。

:::

### 素因数分解の難しさを体感しよう

以下のフォームに自然数を入れて送信すると、素因数分解の結果とかかった実行時間が表示されます。

どのくらいの桁数であれば簡単に素因数分解できてしまうのか、色々と実験してみましょう。

(10秒以上かかると実行失敗となります。)

TODO：素因数分解フォーム

## 数学についての補足

---

数学について気になる方向けの解説です。
読むためには、高校生程度の数学の知識があるとよいです。
読み飛ばして問題ないです。

### mod

$a - b$ が $n$ で割り切れることを $a \equiv b \pmod{n}$ と表し、$\mod{n}$ で $a$ と $b$ は合同であるなどと呼びます。

$a$ を $n$ で割ったあまりと $b$ を $n$ で割ったあまりが等しいことを意味していると考えるのが良いです。

mod は以下の性質を持ちます。

- 和の可換性 $a+b \equiv b+a \pmod{n}$

- 積の可換性 $ab \equiv ba \pmod{n}$

- 和・積の well-defind性 $a \equiv b$　$c \equiv d \pmod{n}$ ならば $a+c \equiv b+d $　$ac \equiv bd \pmod{n}$

### $d$ の存在

$e$ と $ϕ(n)=(p−1)(q−1)$ は互いに素であり、ユークリッドの互除法を用いると、$ae + kϕ(n) = 1$ となる整数 $a, k$ を構成できます。

このとき、$ae \equiv ea \equiv 1 \pmod{ϕ(n)}$ が成り立ちます。

$d \equiv a \pmod{ϕ(n)}$ でかつ $0<d<ϕ(n)$ となる $d$ をとればよいです。

### オイラーの定理

フェルマーの小定理の拡張版です。

#### 主張

もし $a$ と $n$ が互いに素ならば、$\quad a^{ϕ(n)} \equiv 1 \pmod{n}$

#### オイラーのトーシェント関数

正の整数 $n$ に対し、$n$ と互いに素であるような $n$ 以下の正の整数の個数を $ϕ(n)$ で表します。

この $ϕ$ をオイラーのトーシェント関数（オイラーの $ϕ$ 関数、オイラーの関数）と呼びます。

#### 証明

フェルマーの小定理と同様に証明できます。

$n$ と互いに素であるような $n$ 以下の正の整数の集合を $$A = \{b_{1}, b_{2}, ... , b_{ϕ(n)}\}$$ とします。

$A$ のそれぞれの要素に $n$ と互いに素な自然数 $a$ をかけた集合を $$B = \{ab_{1}, ab_{2}, ... , ab_{ϕ(n)}\}$$ とします。

ここで、$\mod{n}$ で合同な要素を同一視しても $B$ の要素数は $ϕ(n)$ です。

（なぜなら、$i \ne j$ に対し $ab_i - ab_j \equiv a(b_i - b_j) \not\equiv 0 \pmod{n}$ であり、$ab_i$ と $ab_j$ は $\mod{n}$ で相異なるからです。）

また、$B$ のすべての要素は $n$ と互いに素です。

よって、$\mod{n}$ において $A$ と $B$ は集合として一致します。

それゆえすべての要素の積も一致し、$b_1b_2...b_{ϕ(n)} \equiv ab_1ab_2...ab_{ϕ(n)} \pmod{n}$

$b_1b_2...b_{ϕ(n)} \equiv a^{ϕ(n)}b_1b_2...b_{ϕ(n)} \pmod{n}$

$(a^{ϕ(n)} - 1)b_1b_2...b_{ϕ(n)} \equiv 0 \pmod{n}$

$b_1b_2...b_{ϕ(n)}$ は $n$ と互いに素なので、$a^{ϕ(n)} \equiv 1 \pmod{n}$ です。
